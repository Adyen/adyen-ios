name: Scan PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - develop
      
jobs:

  build:
    env:
      sonarToken: ${{ secrets.SONAR_TOKEN }}
    runs-on: macos-13-xl

    steps:
    - uses: actions/checkout@v4
    - uses: n1hility/cancel-previous-runs@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Select latest Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '14.3'

    - name: Install Tools
      run: |
        brew install sonar-scanner
        gem install slather

    - name: Validate 3DS2 SDK version
      run: |
        Scripts/validate-3ds2-SDK-version.sh
        
    - name: Validate Adyen SDK version
      run: |
        Scripts/validate-Adyen-SDK-version.sh

    - name: Clean Build and Unit Test
      run: |
        xcodebuild -version
        xcodebuild clean build test -project "${project}" -scheme "${scheme}" ${params} -destination "${destination}" | xcpretty --utf --color && exit ${PIPESTATUS[0]}
      env:
        project: 'Adyen.xcodeproj'
        params: '-derivedDataPath ./DerivedData -enableCodeCoverage YES -skipPackagePluginValidation'
        scheme: 'AdyenUIKitTests'
        destination: 'name=iPhone 14,OS=16.4'
        
    - name: Build and Host UI Test
      run: |
        xcodebuild test -project "${project}" -scheme "${scheme}" ${params} -destination "${destination}" | xcpretty --utf --color && exit ${PIPESTATUS[0]}
      env:
        project: 'Adyen.xcodeproj'
        params: '-derivedDataPath ./DerivedData -enableCodeCoverage YES -skipPackagePluginValidation'
        scheme: 'AdyenUIHostUITests'
        destination: 'name=iPhone 14,OS=16.4'
        
#    - name: Build and Swift UI Test
#      run: |
#        xcodebuild test -project "${project}" -scheme "AdyenSwiftUITests" ${params} -destination "${destination}" -skipPackagePluginValidation -parallel-testing-enabled NO | xcpretty --utf --color && exit ${PIPESTATUS[0]}
#      env:
#        project: 'Adyen.xcodeproj'
#        params: '-derivedDataPath ./DerivedData -enableCodeCoverage YES'
#        scheme: ''
#        destination: 'name=iPhone 14,OS=16.4'

    - name: Code Coverage
      run: |
        slather coverage --sonarqube-xml ${params} ${project}
      env:
        project: 'Adyen.xcodeproj'
        params: '
        --build-directory ./DerivedData
        --output-directory ./reports
        --scheme AdyenUIHost
        --binary-basename Adyen
        --binary-basename AdyenCard
        --binary-basename AdyenDropIn
        --binary-basename AdyenWeChatPay
        --binary-basename AdyenComponents
        --binary-basename AdyenSession
        --binary-basename AdyenEncryption
        --binary-basename AdyenActions
        --binary-basename AdyenCashAppPay
        --binary-basename AdyenSwiftUI'

    - name: SwiftLint
      run: |
        fastlane run swiftlint output_file:"./reports/swiftlint.json" reporter:"json" ignore_exit_status:"true"

    - name: Run Sonar
      if: ${{ env.sonarToken != 0 }}
      run: |
        git fetch --unshallow --no-tags
        sonar-scanner -Dsonar.token=${{ secrets.SONAR_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
