name: Get Release notes
on: 
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get the list of allowed pull request labels
        run: |
          RED='\033[0;31m'
          NC='\033[0m'
          FILE_NAME=.pull-requests-allowed-labels-list
          FILE_PATH=$PROJECT_ROOT/$FILE_NAME
          if [[ ! -f "$FILE_PATH" ]]; then
             echo -e "${RED}$FILE_NAME file doesn't exits in the root of the respository${NC}"
             exit 1
          fi 
          echo "::set-output name=LABELS::$(cat $FILE_PATH)"
        id: get-allowed_labels
        env:
          PROJECT_ROOT: ${{ github.workspace }}
      - run: |
          LATEST_TAG=$(git describe --tags --abbrev=0)
          NUMBER_OF_COMMITS_SINCE_LAST_RELEASE=$(git log --oneline $LATEST_TAG..HEAD | wc -l | sed 's/^ *//g' | sed 's/ *$//g')

          IFS=',' read -r -a ALLOWED_LABELS_ARRAY <<< "$ALLOWED_LABELS"

          OUTPUT=""

          for LABEL in "${ALLOWED_LABELS_ARRAY[@]}"; do
             LABEL=$(echo "$LABEL" | sed 's/^ *//g' | sed 's/ *$//g')
             echo $LABEL
             CMD="git log -$NUMBER_OF_COMMITS_SINCE_LAST_RELEASE"
             CMD="$CMD | awk '/$LABEL\s*:?\s*<p>/,/<\/p>/'"
             $OUTPUT="$OUTPUT\n# $(echo $LABEL)\n$(eval $CMD)"
          done
          echo $OUTPUT
          echo $OUTPUT >> $GITHUB_STEP_SUMMARY
        env:
          ALLOWED_LABELS: ${{ steps.get-allowed_labels.outputs.LABELS }}