name: Get Release notes
on: 
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]
jobs:
  release_notes:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get the list of allowed pull request labels
        run: |
          RED='\033[0;31m'
          NC='\033[0m'
          FILE_NAME=.pull-requests-allowed-labels-list
          FILE_PATH=$PROJECT_ROOT/$FILE_NAME
          if [[ ! -f "$FILE_PATH" ]]; then
             echo -e "${RED}$FILE_NAME file doesn't exits in the root of the respository${NC}"
             exit 1
          fi 
          echo "LABELS=$(cat $FILE_PATH)" >> $GITHUB_OUTPUT
        id: get-allowed_labels
        env:
          PROJECT_ROOT: ${{ github.workspace }}
      - name: Generate release notes
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0)
          NUMBER_OF_COMMITS_SINCE_LAST_RELEASE=$(git log --oneline $LATEST_TAG..HEAD | wc -l | sed 's/^ *//g' | sed 's/ *$//g')

          IFS=',' read -r -a ALLOWED_LABELS_ARRAY <<< "$ALLOWED_LABELS"

          OUTPUT=""

          for LABEL in "${ALLOWED_LABELS_ARRAY[@]}"; do
             LABEL=$(echo "$LABEL" | sed 's/^ *//g' | sed 's/ *$//g')
             GIT_LOG_CMD="git log -$NUMBER_OF_COMMITS_SINCE_LAST_RELEASE"
             COMMIT_MESSAGES=$(eval $GIT_LOG_CMD)
             echo $COMMIT_MESSAGES
             FIND_CMD="awk '/#\s*$LABEL\s*:?\s*<p>/,/<\/p>/'"
             LABEL_OUTPUT="$(echo $COMMIT_MESSAGES | eval $FIND_CMD)"
             echo $LABEL_OUTPUT
             if [ ! -z "$LABEL_OUTPUT" ]; then
                OUTPUT="$OUTPUT\n\# $LABEL\n$LABEL_OUTPUT"
             fi
          done
          if [ ! -z "$OUTPUT" ]; then
             echo $OUTPUT
             echo $OUTPUT >> $GITHUB_STEP_SUMMARY
          fi
        env:
          ALLOWED_LABELS: ${{ steps.get-allowed_labels.outputs.LABELS }}