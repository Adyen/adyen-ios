name: Scan PR

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - develop
      
jobs:

  build:
    env:
      sonarToken: ${{ secrets.SONAR_TOKEN }}
      destination: "name=iPhone 15 Pro,OS=17.2"
      project: "Adyen.xcodeproj"
      params: "-derivedDataPath ./DerivedData -skipPackagePluginValidation"
    runs-on: macos-14-xlarge # Apple Silicon Runner

    steps:
    - uses: actions/checkout@v4
    - uses: n1hility/cancel-previous-runs@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Validate Versions
      run: |
        Scripts/validate-3ds2-SDK-version.sh
        Scripts/validate-Adyen-SDK-version.sh

    - name: Select latest Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.1'

    - name: üõ†Ô∏è Install Tools
      run: |
        brew install sonar-scanner
        
    - name: üîç Detect Changes
      run: |
        Scripts/generate_public_interface_definition.sh
        ./Scripts/compare_public_interface_definition.swift ${{ github.event.pull_request.base.ref }} ${{ github.server_url }}/${{ github.repository }}
      env:
        params: '${{env.params}}'
        scheme: 'AdyenUIHost'
